name: Built site checks

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  actions: read
  contents: read

jobs:
  built-site-checks:
    if: ${{ !startsWith(github.head_ref, 'deepsource-') }}
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0 # Full git history for commit counting

      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-env

      - name: Build site
        run: pnpm build

      - name: Check CSS variables
        run: |
          # Run stylelint to check for unknown CSS variables
          # Filter out known false positives and check if any real issues remain
          WARNINGS=$(pnpm exec stylelint public/index.css \
            --config config/stylelint/.variables-only-stylelintrc.json 2>&1 \
            | grep -vE 'shiki|problems|public/index.css' \
            | grep . || true)

          if [ -n "$WARNINGS" ]; then
            echo "Error: Found unknown CSS variable(s):"
            echo "$WARNINGS"
            exit 1
          fi

      - name: Run built site checks
        run: uv run python scripts/built_site_checks.py
