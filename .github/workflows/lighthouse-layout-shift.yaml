name: Lighthouse Testing

concurrency:
  group: lighthouse-testing-${{ github.event_name }}-${{ github.ref_name }}
  cancel-in-progress: true

on:
  push:
    branches: ["main", "dev", "no-layout-shift"]
    paths:
      - "quartz/**/*.scss"
      - "quartz/**/*.tsx"
      - "quartz/**/*.ts"
      - "quartz/static/**"
      - "config/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - ".github/actions/**"
      - ".github/lighthouse-*.json"

jobs:
  build_and_deploy:
    runs-on: ubuntu-24.04
    permissions:
      actions: read
      contents: read
      id-token: write
      pages: write
    outputs:
      deploy_url: ${{ steps.deploy_cf_pages.outputs.DEPLOY_URL }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Setup Build Environment
        uses: ./.github/actions/setup-build-env

      - name: Build Quartz
        run: pnpm build

      - name: Install Wrangler
        run: pnpm add -g wrangler

      - name: Publish to Cloudflare Pages for Lighthouse testing
        id: deploy_cf_pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-8)
          DEPLOY_OUTPUT=$(pnpm exec wrangler pages deploy ./public --project-name=turntrout --branch=commit-${SHORT_SHA} --commit-dirty=true)

          echo "Wrangler deployment output:"
          echo "${DEPLOY_OUTPUT}"

          DEPLOY_URL=$(echo "${DEPLOY_OUTPUT}" | grep -o 'https://[a-zA-Z0-9.-]*pages.dev' | tail -n 1)

          if [[ -z "$DEPLOY_URL" ]]; then
            echo "::error::Could not determine deployment URL from Wrangler output using primary method."
            DEPLOY_URL=$(echo "${DEPLOY_OUTPUT}" | grep -o 'https://[a-zA-Z0-9.-]*pages.dev' | tail -n 1)
            if [[ -z "$DEPLOY_URL" ]]; then
              echo "::error::Fallback URL extraction also failed. Please check Wrangler output."
              exit 1
            fi
          fi

          echo "Extracted DEPLOY_URL: $DEPLOY_URL"
          echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_OUTPUT

  lighthouse_desktop:
    runs-on: ubuntu-24.04
    needs: build_and_deploy
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Run Lighthouse CI against Cloudflare deployment (Desktop)
        id: lighthouse_desktop
        uses: treosh/lighthouse-ci-action@03becbfc543944dd6e7534f7ff768abb8a296826 # v10
        with:
          urls: |
            ${{ needs.build_and_deploy.outputs.deploy_url }}/design
            ${{ needs.build_and_deploy.outputs.deploy_url }}/test-page
            ${{ needs.build_and_deploy.outputs.deploy_url }}/test-page#spoilers
            ${{ needs.build_and_deploy.outputs.deploy_url }}/test-page#videos
            ${{ needs.build_and_deploy.outputs.deploy_url }}/test-page#admonitions
            ${{ needs.build_and_deploy.outputs.deploy_url }}/test-page#footnote-label
          temporaryPublicStorage: true
          configPath: ".github/lighthouse-cls-only-config.json"

      - name: Upload Lighthouse reports (Desktop)
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: lighthouse-reports-desktop
          path: /home/runner/work/TurnTrout.com/TurnTrout.com/.lighthouseci/
          retention-days: 1

  lighthouse_mobile:
    runs-on: ubuntu-24.04
    needs: build_and_deploy
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Run Lighthouse CI against Cloudflare deployment (Mobile)
        id: lighthouse_mobile
        uses: treosh/lighthouse-ci-action@03becbfc543944dd6e7534f7ff768abb8a296826 # v10
        with:
          urls: |
            ${{ needs.build_and_deploy.outputs.deploy_url }}/design
            ${{ needs.build_and_deploy.outputs.deploy_url }}/test-page
            ${{ needs.build_and_deploy.outputs.deploy_url }}/test-page#spoilers
            ${{ needs.build_and_deploy.outputs.deploy_url }}/test-page#videos
            ${{ needs.build_and_deploy.outputs.deploy_url }}/test-page#admonitions
            ${{ needs.build_and_deploy.outputs.deploy_url }}/test-page#footnote-label
          temporaryPublicStorage: true
          configPath: ".github/lighthouse-cls-only-config-mobile.json"

      - name: Upload Lighthouse reports (Mobile)
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: lighthouse-reports-mobile
          path: /home/runner/work/TurnTrout.com/TurnTrout.com/.lighthouseci/
          retention-days: 1

  lighthouse_accessibility:
    runs-on: ubuntu-24.04
    needs: build_and_deploy
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Run Lighthouse Accessibility Audit
        id: lighthouse_a11y
        uses: treosh/lighthouse-ci-action@03becbfc543944dd6e7534f7ff768abb8a296826 # v10
        with:
          urls: |
            ${{ needs.build_and_deploy.outputs.deploy_url }}/
            ${{ needs.build_and_deploy.outputs.deploy_url }}/design
            ${{ needs.build_and_deploy.outputs.deploy_url }}/about
            ${{ needs.build_and_deploy.outputs.deploy_url }}/research
            ${{ needs.build_and_deploy.outputs.deploy_url }}/test-page
            ${{ needs.build_and_deploy.outputs.deploy_url }}/posts
          temporaryPublicStorage: true
          configPath: ".github/lighthouse-a11y-config.json"

      - name: Upload Lighthouse Accessibility reports
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: lighthouse-reports-accessibility
          path: /home/runner/work/TurnTrout.com/TurnTrout.com/.lighthouseci/
          retention-days: 1
