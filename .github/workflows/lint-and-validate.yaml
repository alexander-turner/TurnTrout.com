name: Lint and validate

concurrency:
  group: lint-validate-${{ github.event_name }}-${{ github.ref_name }}
  cancel-in-progress: true

on:
  push:
    branches: ["main", "dev"]
    paths:
      - "quartz/**"
      - "website_content/**"
      - "config/**"
      - "scripts/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - "pyproject.toml"
      - "uv.lock"
      - ".github/actions/**"
  pull_request:
    paths:
      - "quartz/**"
      - "website_content/**"
      - "config/**"
      - "scripts/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - "pyproject.toml"
      - "uv.lock"
      - ".github/actions/**"
  merge_group:
  schedule:
    - cron: "16 12 * * 4"

permissions:
  actions: read
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-24.04
    outputs:
      content: ${{ steps.changes.outputs.content }}
      code: ${{ steps.changes.outputs.code }}
      styles: ${{ steps.changes.outputs.styles }}
      source-checks: ${{ steps.changes.outputs.source-checks }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            content:
              - 'website_content/**'
              - 'config/spellcheck/**'
              - 'config/vale/**'
            code:
              - 'quartz/**'
              - 'config/javascript/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - '.github/actions/**'
            styles:
              - 'quartz/**/*.scss'
              - 'config/stylelint/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - '.github/actions/**'
            source-checks:
              - 'website_content/**'
              - 'quartz/**'
              - 'scripts/source_file_checks.py'
              - 'config/**'
              - '.github/actions/**'

  spellcheck:
    needs: detect-changes
    if: needs.detect-changes.outputs.content == 'true' && !startsWith(github.head_ref, 'deepsource-')
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup base environment
        uses: ./.github/actions/setup-base-env

      - name: Run spellcheck
        run: |
          pnpm exec spellchecker \
            --no-suggestions \
            --quiet \
            --dictionaries config/spellcheck/.wordlist.txt \
            --files "website_content/**/*.md" \
            --ignore '(?=.{10,})[\da-zA-Z]+(\-[\da-zA-Z]+)+' \
            --plugins spell indefinite-article repeated-words syntax-urls frontmatter

  vale:
    needs: detect-changes
    if: needs.detect-changes.outputs.content == 'true' && !startsWith(github.head_ref, 'deepsource-')
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Vale
        run: |
          wget -q https://github.com/errata-ai/vale/releases/download/v3.9.0/vale_3.9.0_Linux_64-bit.tar.gz
          tar -xzf vale_3.9.0_Linux_64-bit.tar.gz
          sudo mv vale /usr/local/bin/

      - name: Run Vale
        run: |
          vale --config config/vale/.vale.ini website_content

  eslint:
    needs: detect-changes
    if: >
      always() &&
      ((needs.detect-changes.outputs.code == 'true' && !startsWith(github.head_ref, 'deepsource-'))
      || github.event_name == 'schedule')
    name: Run eslint scanning
    runs-on: ubuntu-24.04
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup base environment
        uses: ./.github/actions/setup-base-env

      - name: Run ESLint
        run: pnpm eslint .
          --config config/javascript/eslint.config.js

  stylelint:
    needs: detect-changes
    if: needs.detect-changes.outputs.styles == 'true' && !startsWith(github.head_ref, 'deepsource-')
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup base environment
        uses: ./.github/actions/setup-base-env

      - name: Generate SCSS variables
        run: pnpm exec tsx quartz/styles/generate-variables.ts

      - name: Run Stylelint
        run: |
          pnpm exec stylelint \
            --config config/stylelint/.stylelintrc.json \
            "quartz/**/*.scss"

  source-file-checks:
    needs: detect-changes
    if: needs.detect-changes.outputs.source-checks == 'true' && !startsWith(github.head_ref, 'deepsource-')
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup base environment
        uses: ./.github/actions/setup-base-env

      - name: Generate SCSS variables
        run: pnpm exec tsx quartz/styles/generate-variables.ts

      - name: Add node_modules/.bin to PATH
        run: echo "${{ github.workspace }}/node_modules/.bin" >> $GITHUB_PATH

      - name: Run source file checks
        run: uv run python scripts/source_file_checks.py --check-publication-dates
