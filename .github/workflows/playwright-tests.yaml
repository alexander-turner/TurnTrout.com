name: Playwright Tests

concurrency:
  group: "playwright-tests"
  cancel-in-progress: true

on:
  push:
    branches: ["lostpixel"]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard:
          [
            1/80,
            2/80,
            3/80,
            4/80,
            5/80,
            6/80,
            7/80,
            8/80,
            9/80,
            10/80,
            11/80,
            12/80,
            13/80,
            14/80,
            15/80,
            16/80,
            17/80,
            18/80,
            19/80,
            20/80,
            21/80,
            22/80,
            23/80,
            24/80,
            25/80,
            26/80,
            27/80,
            28/80,
            29/80,
            30/80,
            31/80,
            32/80,
            33/80,
            34/80,
            35/80,
            36/80,
            37/80,
            38/80,
            39/80,
            40/80,
            41/80,
            42/80,
            43/80,
            44/80,
            45/80,
            46/80,
            47/80,
            48/80,
            49/80,
            50/80,
            51/80,
            52/80,
            53/80,
            54/80,
            55/80,
            56/80,
            57/80,
            58/80,
            59/80,
            60/80,
            61/80,
            62/80,
            63/80,
            64/80,
            65/80,
            66/80,
            67/80,
            68/80,
            69/80,
            70/80,
            71/80,
            72/80,
            73/80,
            74/80,
            75/80,
            76/80,
            77/80,
            78/80,
            79/80,
            80/80,
          ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ">=22"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: |
          npx playwright install --with-deps
          npx playwright install-deps

      - name: Serve Quartz
        run: |
          npx quartz build --serve &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV

      - name: Wait for server
        run: |
          # Wait for the server to be ready
          while ! nc -z localhost 8080; do
            sleep 0.1 # Check every 100ms
            # Check if server is still running
            if ! ps -p "$SERVER_PID" > /dev/null; then
              echo "Server failed to start"
              exit 1
            fi
          done
          echo "Server is ready"

      - name: Wait for server
        run: |
          # Wait for the server to be ready
          while ! nc -z localhost 8080; do
            sleep 0.1 # Check every 100ms
            # Check if server is still running
            if ! ps -p "$SERVER_PID" > /dev/null; then
              echo "Server failed to start"
              exit 1
            fi
          done
          echo "Server is ready"

      - name: Run Playwright tests
        run: |
          npx playwright test --config playwright.config.ts --grep "^(?:(?!lostpixel).)*$" --shard ${{ matrix.shard }}

      - name: Sanitize shard name
        run: echo "SANITIZED_SHARD=${MATRIX_SHARD%%/*}" >> $GITHUB_ENV
        env:
          MATRIX_SHARD: ${{ matrix.shard }}

      - name: Upload Playwright traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-${{ strategy.job-index }}-${{ env.SANITIZED_SHARD }}
          path: test-results/
          retention-days: 7
