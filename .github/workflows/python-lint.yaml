name: Python linting

concurrency:
  group: python-lint-${{ github.event_name }}-${{ github.ref_name }}
  cancel-in-progress: true

on:
  push:
    branches: ["main", "dev"]
  pull_request:
  merge_group:

permissions:
  actions: read
  contents: read

jobs:
  detect-changes:
    runs-on: ubuntu-24.04
    outputs:
      python: ${{ steps.changes.outputs.python }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: changes
        with:
          filters: |
            python:
              - 'scripts/**'
              - 'config/python/**'
              - 'pyproject.toml'
              - 'uv.lock'
              - '.github/actions/**'

  python-lint:
    needs: detect-changes
    if: >
      !startsWith(github.head_ref, 'deepsource-') &&
      needs.detect-changes.outputs.python == 'true'
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup base environment
        uses: ./.github/actions/setup-base-env
        with:
          install-node-deps: "false"

      - name: Run mypy
        run: |
          uv run python -m mypy \
            --config-file config/python/mypy.ini \
            scripts/*.py

      - name: Run docformatter check
        run: |
          uv run python -m docformatter \
            --check \
            --config config/python/pyproject.toml \
            scripts/*.py

      - name: Run pylint
        run: |
          uv run python -m pylint \
            --rcfile config/python/.pylintrc \
            .
