#!/bin/bash

commit_hash="$(git rev-parse HEAD)"
git_root="$(git rev-parse --show-toplevel)"
timestamps_repo="$git_root/.timestamps"
timestamps_dir="$timestamps_repo/files"

rollback() {
  echo "ERROR: $1"
  echo "Undoing commit..."
  cd "$git_root" && git reset --soft HEAD~1
  exit 1
}

# Check if .timestamps is a git repo
if [ ! -d "$timestamps_repo/.git" ]; then
  echo "ERROR: .timestamps is not a git repo!"
  echo "Please clone it with: git clone https://github.com/alexander-turner/.timestamps .timestamps"
  exit 1
fi

# Find ots binary (check multiple locations)
OTS_BIN=""
if [ -x "/opt/homebrew/anaconda3/envs/website/bin/ots" ]; then
  OTS_BIN="/opt/homebrew/anaconda3/envs/website/bin/ots"
elif command -v ots >/dev/null 2>&1; then
  OTS_BIN="$(command -v ots)"
fi

if [ -z "$OTS_BIN" ]; then
  echo "ERROR: ots not found!"
  echo "Install with: pip3 install opentimestamps-client"
  exit 1
fi

mkdir -p "$timestamps_dir"
txt_file="$timestamps_dir/$commit_hash.txt"
printf '%s' "$commit_hash" >"$txt_file"

# Try to create timestamp with relaxed requirements (accept 1 calendar response, 10s timeout)
ots_output=$(ots stamp -m 1 --timeout 10 "$txt_file" 2>&1)
ots_exit=$?

if [ $ots_exit -ne 0 ]; then
  echo "OpenTimestamp output: $ots_output" >&2
  rollback "Failed to create OpenTimestamp proof! This may be due to network issues or insufficient calendar server responses."
fi

# Wait for .ots file to be created (up to 5 seconds)
ots_file="$txt_file.ots"
count=0
while [ $count -lt 50 ]; do
  [ -f "$ots_file" ] && break
  sleep 0.1
  count=$((count + 1))
done
[ -f "$ots_file" ] || rollback "OpenTimestamp .ots file was not created!"

cd "$timestamps_repo" || rollback "Failed to change to timestamps directory!"
git add "files/$commit_hash.txt" "files/$commit_hash.txt.ots" || rollback "Failed to add timestamp files!"
git commit -m "Add OpenTimestamp proof for commit $commit_hash" --quiet || rollback "Failed to commit timestamp files!"

# Push to timestamps repo
if ! git push --quiet 2>/dev/null; then
  echo "ERROR: Could not push to .timestamps repo (no credentials?)."
  cd "$git_root"
  exit 1
fi

cd "$git_root" || exit 1
