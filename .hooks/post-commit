#!/bin/sh

commit_hash="$(git rev-parse HEAD)"
git_root="$(git rev-parse --show-toplevel)"
timestamps_repo="$git_root/.timestamps"
timestamps_dir="$timestamps_repo/files"

rollback() {
  echo "ERROR: $1"
  echo "Undoing commit..."
  cd "$git_root" && git reset --soft HEAD~1
  exit 1
}

mkdir -p "$timestamps_dir"
txt_file="$timestamps_dir/$commit_hash.txt"
printf '%s' "$commit_hash" >"$txt_file"

/opt/homebrew/anaconda3/envs/website/bin/ots stamp "$txt_file" >/dev/null 2>&1 || rollback "Failed to create OpenTimestamp proof! Make sure 'ots' is installed."

cd "$timestamps_repo" || rollback "Failed to change to timestamps directory!"
git add "files/$commit_hash.txt" "files/$commit_hash.txt.ots" || rollback "Failed to add timestamp files!"
git commit -m "Add OpenTimestamp proof for commit $commit_hash" --quiet || rollback "Failed to commit timestamp files!"
git push --quiet || rollback "Failed to push timestamp files!"
cd "$git_root" || exit 1
