#!/bin/bash

GIT_ROOT=$(git rev-parse --show-toplevel)

# Check if .timestamps directory exists
if [ ! -d "$GIT_ROOT/.timestamps" ]; then
  echo "ERROR: .timestamps directory not found!"
  echo "Please clone it with: git clone https://github.com/alexander-turner/.timestamps .timestamps"
  exit 1
fi

# Use unique temp files to avoid conflicts with parallel commits
BEFORE_FORMAT=$(mktemp)
AFTER_FORMAT=$(mktemp)
trap 'rm -f "$BEFORE_FORMAT" "$AFTER_FORMAT"' EXIT

# Use cross-platform stat syntax
if [[ "$OSTYPE" == "darwin"* ]]; then
  STAT_CMD='stat -f "%m %N"'
else
  STAT_CMD='stat -c "%Y %n"'
fi

# Store file modification times before formatting
find "$GIT_ROOT"/scripts -name "*.py" -type f -exec sh -c "$STAT_CMD \"\$1\"" _ {} \; >"$BEFORE_FORMAT"

# Format Python files (use find to get proper glob expansion)
find "$GIT_ROOT"/scripts -name "*.py" -type f -print0 | xargs -0 docformatter --in-place --config "$GIT_ROOT"/config/python/pyproject.toml 2>/dev/null || true
find "$GIT_ROOT"/scripts -name "*.py" -type f -print0 | xargs -0 pyupgrade 2>/dev/null || true

# Store file modification times after formatting
find "$GIT_ROOT"/scripts -name "*.py" -type f -exec sh -c "$STAT_CMD \"\$1\"" _ {} \; >"$AFTER_FORMAT"

# Compare and stage only modified files
diff "$BEFORE_FORMAT" "$AFTER_FORMAT" | grep ">" | cut -d' ' -f3- | xargs -I {} git add {}

# Run lint-staged using pnpm
pnpm exec lint-staged --allow-empty
