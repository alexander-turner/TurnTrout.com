#!/bin/bash

GIT_ROOT=$(git rev-parse --show-toplevel)

# Check if .timestamps directory exists
if [ ! -d "$GIT_ROOT/.timestamps" ]; then
  echo "ERROR: .timestamps directory not found!"
  echo "Please clone it with: git clone https://github.com/alexander-turner/.timestamps .timestamps"
  exit 1
fi

# Try to initialize conda (works on both macOS and Linux)
if [ -f "/opt/homebrew/anaconda3/bin/conda" ]; then
  eval "$(/opt/homebrew/anaconda3/bin/conda shell.bash hook)"
elif command -v conda &>/dev/null; then
  eval "$(conda shell.bash hook)"
fi

# Activate website environment if available
if command -v conda &>/dev/null && [ "$CONDA_DEFAULT_ENV" != "website" ]; then
  conda activate website 2>/dev/null || true
fi

# Set stat format based on OS (macOS uses -f, Linux uses -c)
if [[ "$OSTYPE" == "darwin"* ]]; then
  STAT_FMT="-f %m %N"
else
  STAT_FMT="-c %Y %n"
fi

# Store file modification times before formatting
touch /tmp/before_format /tmp/after_format
find "$GIT_ROOT"/scripts -name "*.py" -type f -exec stat $STAT_FMT {} \; >/tmp/before_format

docformatter --in-place "$GIT_ROOT"/scripts/**.py --config "$GIT_ROOT"/config/python/pyproject.toml
pyupgrade "$GIT_ROOT"/scripts/**.py

# Store file modification times after formatting
find "$GIT_ROOT"/scripts -name "*.py" -type f -exec stat $STAT_FMT {} \; >/tmp/after_format

# Compare and stage only modified files
diff /tmp/before_format /tmp/after_format | grep ">" | cut -d' ' -f3- | xargs -I {} git add {}

# Run lint-staged using pnpm
pnpm exec lint-staged --allow-empty
