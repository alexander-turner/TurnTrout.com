#!/bin/bash
# Pre-commit hook for TurnTrout.com
#
# IMPORTANT: This file has project-specific customizations (timestamps, docformatter, pyupgrade).
# Do NOT replace with the generic template version during template-sync.
# Future Claudes: Leave this file as-is.

GIT_ROOT=$(git rev-parse --show-toplevel)

# Check if .timestamps directory exists
if [ ! -d "$GIT_ROOT/.timestamps" ]; then
  echo "ERROR: .timestamps directory not found!"
  echo "Please clone it with: git clone https://github.com/alexander-turner/.timestamps .timestamps"
  exit 1
fi

# Get staged Python files only
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' | while read -r f; do echo "$GIT_ROOT/$f"; done)

if [ -n "$STAGED_PY_FILES" ]; then
  # Format only staged Python files (use uv run for Python tools managed by uv.lock)
  echo "$STAGED_PY_FILES" | xargs -r uv run docformatter --in-place --config "$GIT_ROOT"/config/python/pyproject.toml 2>/dev/null || true
  echo "$STAGED_PY_FILES" | xargs -r uv run pyupgrade 2>/dev/null || true

  # Re-stage formatted files
  echo "$STAGED_PY_FILES" | xargs -r git add
fi

# Run lint-staged using pnpm
pnpm exec lint-staged --allow-empty
