#!/bin/bash

GIT_ROOT=$(git rev-parse --show-toplevel)

# Check if .timestamps directory exists
if [ ! -d "$GIT_ROOT/.timestamps" ]; then
  echo "ERROR: .timestamps directory not found!"
  echo "Please clone it with: git clone https://github.com/alexander-turner/.timestamps .timestamps"
  exit 1
fi

# Try to initialize conda (works on both macOS and Linux)
if [ -f "/opt/homebrew/anaconda3/bin/conda" ]; then
  eval "$(/opt/homebrew/anaconda3/bin/conda shell.bash hook)"
elif command -v conda &>/dev/null; then
  eval "$(conda shell.bash hook)"
fi

# Activate website environment if available
if command -v conda &>/dev/null && [ "$CONDA_DEFAULT_ENV" != "website" ]; then
  conda activate website 2>/dev/null || true
fi

# Python formatting (skip if tools not available)
if command -v docformatter &>/dev/null && command -v pyupgrade &>/dev/null; then
  # Store file modification times before formatting (cross-platform)
  touch /tmp/before_format /tmp/after_format
  if [[ "$OSTYPE" == "darwin"* ]]; then
    find "$GIT_ROOT"/scripts -name "*.py" -type f -exec stat -f "%m %N" {} \; >/tmp/before_format
  else
    find "$GIT_ROOT"/scripts -name "*.py" -type f -exec stat -c "%Y %n" {} \; >/tmp/before_format
  fi

  docformatter --in-place "$GIT_ROOT"/scripts/**.py --config "$GIT_ROOT"/config/python/pyproject.toml 2>/dev/null || true
  pyupgrade "$GIT_ROOT"/scripts/**.py 2>/dev/null || true

  # Store file modification times after formatting
  if [[ "$OSTYPE" == "darwin"* ]]; then
    find "$GIT_ROOT"/scripts -name "*.py" -type f -exec stat -f "%m %N" {} \; >/tmp/after_format
  else
    find "$GIT_ROOT"/scripts -name "*.py" -type f -exec stat -c "%Y %n" {} \; >/tmp/after_format
  fi

  # Compare and stage only modified files
  diff /tmp/before_format /tmp/after_format | grep ">" | cut -d' ' -f3- | xargs -I {} git add {}
fi

# Run lint-staged if available
if command -v pnpm &>/dev/null && [ -f "$GIT_ROOT/node_modules/.bin/lint-staged" ]; then
  pnpm exec lint-staged --allow-empty
fi
