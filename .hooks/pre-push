#!/bin/sh
set -e

RESUME_FLAG=""
if [ "$RESUME" = "true" ]; then
  echo "Resuming from last failed step."
  RESUME_FLAG="--resume"
fi

PUSHED_CHANGES=0
trap 'handle_cleanup "$PUSHED_CHANGES"' EXIT

# Main script logic first
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Handle cleanup function separately
# shellcheck disable=SC2317
handle_cleanup() {
  _exit_code=$?

  # Explicitly set error handling
  set +e

  _pushed_changes=$1
  if [ "$_pushed_changes" -eq 1 ]; then
    echo "Restoring stashed changes..."
    git stash pop >>/dev/null || true
  fi

  return "$_exit_code"
}

# If there are any changes, stash them and return 1, otherwise return 0.
stash_and_exit() {
  PREV_NUM_STASHES=$(git stash list | wc -l)
  git stash push --include-untracked >>/dev/null
  # Check if anything was stashed
  if [ "$(git stash list | wc -l)" -gt "$PREV_NUM_STASHES" ]; then
    echo "1"
  else
    echo "0"
  fi
}

GIT_ROOT=$(git rev-parse --show-toplevel)
cd "$GIT_ROOT"

# Try to activate conda environment if available
if command -v conda >/dev/null 2>&1; then
  ACTIVE_ENV=$(conda info 2>/dev/null | grep 'active environment' | awk '{print $NF}' || true)

  if [ "$ACTIVE_ENV" != "website" ]; then
    CONDA_BASE=$(conda info --base 2>/dev/null || true)
    if [ -n "$CONDA_BASE" ] && [ -f "$CONDA_BASE/etc/profile.d/conda.sh" ]; then
      echo "Activating conda environment: website"
      # shellcheck source=/dev/null
      . "$CONDA_BASE/etc/profile.d/conda.sh"
      conda activate website 2>/dev/null || true
    fi
  fi
fi

# Verify uv is available (required for running checks)
if ! command -v uv >/dev/null 2>&1; then
  echo "ERROR: uv is not installed. Please install it: curl -LsSf https://astral.sh/uv/install.sh | sh"
  exit 1
fi

if [ "$RESUME" != "true" ]; then
  PUSHED_CHANGES=$(stash_and_exit)
fi

# Determine if we should run checks
# Run for main branch and claude/* branches (PRs from Claude)
case "$CURRENT_BRANCH" in
  main)
    BRANCH_FLAG=""
    ;;
  claude/*)
    BRANCH_FLAG="--feature-branch"
    ;;
  *)
    # Skip checks for other branches
    exit 0
    ;;
esac

uv run python "$GIT_ROOT/scripts/run_push_checks.py" $RESUME_FLAG $BRANCH_FLAG

# Auto-compile requirements.txt and update publication dates (main branch only)
if [ "$CURRENT_BRANCH" = "main" ]; then
  sh "$GIT_ROOT/scripts/fast_pre_push.sh"
fi
