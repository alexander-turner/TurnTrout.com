#!/usr/bin/env node

import { readFileSync, writeFileSync } from "fs"
import { execSync } from "child_process"

const [, , COMMIT_MSG_FILE, COMMIT_SOURCE] = process.argv

/**
 * Git calls `prepare-commit-msg` for *all* commits, including:
 * - `git commit -m "..."`        => COMMIT_SOURCE="message"
 * - merges/squashes              => COMMIT_SOURCE="merge"/"squash"
 * - `git commit --amend`         => COMMIT_SOURCE="commit"
 * - normal editor flow           => COMMIT_SOURCE is usually undefined
 *
 * We only want to auto-generate a message when the user is in the normal editor
 * flow and the message is still the default template (i.e. they haven't typed
 * their own message).
 */
if (["message", "merge", "squash", "commit"].includes(COMMIT_SOURCE)) {
  process.exit(0)
}

// If the user already typed a message in COMMIT_EDITMSG (e.g. they started an
// interactive commit and then re-ran `git commit`), don't overwrite it.
try {
  const existing = readFileSync(COMMIT_MSG_FILE, "utf8")
  const nonCommentLines = existing
    .split("\n")
    .map((l) => l.trim())
    .filter((l) => l.length > 0 && !l.startsWith("#"))

  if (nonCommentLines.length > 0) {
    process.exit(0)
  }
} catch {
  // If we can't read the file for some reason, fall through and let the hook
  // attempt generation (Git will surface any real error).
}

// Get API key from envchain
let API_KEY
try {
  const result = execSync("envchain ai sh -c 'echo $REDPILL_API_KEY'", {
    encoding: "utf8",
  })
  API_KEY = result?.trim()
} catch (error) {
  console.error("Error: Failed to retrieve REDPILL_API_KEY from envchain")
  console.error("Make sure you have set it with: envchain --set ai REDPILL_API_KEY")
  process.exit(1)
}

if (!API_KEY) {
  console.error("Error: REDPILL_API_KEY is empty in envchain")
  process.exit(1)
}

async function generateCommitMessage() {
  // Get staged diff
  const diffResult = execSync("git diff --cached --no-color --no-ext-diff", {
    encoding: "utf8",
    maxBuffer: 10 * 1024 * 1024,
  })
  const diff = diffResult?.trim() || ""

  if (!diff) {
    console.log("No staged changes")
    process.exit(0)
  }

  // Truncate if needed
  const truncatedDiff = diff.length > 8000 ? diff.substring(0, 8000) + "\n... (truncated)" : diff

  const prompt = `Generate a conventional commit message for these changes. Format: type(scope): description

Use types: feat, fix, refactor, docs, test, chore, style, perf
First line max 72 chars, imperative mood, no emoji.
Add blank line then body with details if needed.
Don't spend too long thinking about it.

Return ONLY the commit message, no explanation.

Diff:
\`\`\`
${truncatedDiff}
\`\`\``

  const response = await fetch("https://api.redpill.ai/v1/chat/completions", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${API_KEY}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      model: "google/gemini-3-pro-preview",
      messages: [{ role: "user", content: prompt }],
      temperature: 0.3,
      max_tokens: 4000,
    }),
  })

  if (!response.ok) {
    const error = await response.text()
    throw new Error(`API error (${response.status}): ${error}`)
  }

  const data = await response.json()

  if (!data?.choices?.[0]?.message?.content) {
    if (data?.choices?.[0]?.finish_reason === "MAX_TOKENS") {
      throw new Error("Model exceeded token limit. Please try again or reduce diff size.")
    }
    console.error("Unexpected API response:", JSON.stringify(data, null, 2))
    throw new Error("API response missing expected content field")
  }

  const message = data.choices[0].message.content.trim().replace(/^["']|["']$/g, "")

  // Prepend to existing template
  const existingContent = readFileSync(COMMIT_MSG_FILE, "utf8")
  writeFileSync(COMMIT_MSG_FILE, `${message}\n\n${existingContent}`)

  console.log(`âœ“ ${message.split("\n")[0]}`)
}

generateCommitMessage().catch((error) => {
  console.error("Error:", error.message)
  process.exit(1)
})
